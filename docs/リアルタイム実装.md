# リアルタイム実装まとめ

> 最終更新: 2026-02-22

## 1. 実装の目的

「編集完了」ボタン押下前でも、他ブラウザに編集内容を反映させることを目的に、セクション編集の同期経路を整理した。

## 2. 実装結果（現在の同期方式）

現在は以下の **二段構え** で同期する。

1. **即時同期（Broadcast）**
   - 編集中に `section-content` イベントを Supabase Realtime Broadcast で送信
   - 受信側は即座に `liveContent` を表示更新

2. **フォールバック同期（自動保存 + ポーリング）**
   - 編集中、2秒ごとに差分があれば `PUT /sections/{id}` をサイレント実行
   - 閲覧側は `usePlotDetail` の2秒ポーリングで最新DB内容を取得
   - WebSocket不調時でも、数秒以内に他ブラウザへ反映できる

## 3. 主要変更ポイント

### Realtime Provider

- `frontend/src/lib/realtime/provider.ts`
  - Realtime Provider を `SupabaseBroadcastProvider` ベースに統一
- `frontend/src/lib/realtime/provider.test.ts`
  - チャネルモックを `channel().on().subscribe()` のチェーン構造に対応

### Realtime 状態管理

- `frontend/src/hooks/usePlotRealtime.ts`
  - provider の `status/connect/error` イベントを監視
  - Awareness 変化からロック状態マップを再計算

### 編集UI・同期

- `frontend/src/components/section/SectionEditor/SectionEditor.tsx`
  - `onChange` で `broadcastContent(sectionId, json)` を送信
  - `provider` を `ref` 経由で参照し stale closure を回避
  - 編集中に2秒間隔の自動保存（silent）を追加

- `frontend/src/components/plot/PlotDetail/PlotDetail.tsx`
  - `onSave` を `Promise<boolean>` 化
  - `options?: { silent?: boolean }` に対応（自動保存時はトースト非表示）
  - Realtime接続状態バッジを表示

- `frontend/src/hooks/usePlots.ts`
  - `usePlotDetail` に `refetchInterval: 2000` を設定し、保存結果の追従性を向上

### 閲覧UI・同期

- `frontend/src/components/section/SectionViewer/SectionViewer.tsx`
  - provider から `section-content` を購読して `liveContent` を反映
- `frontend/src/components/section/SectionList/SectionList.tsx`
  - `SectionViewer` に provider を受け渡し

## 4. ドキュメント仕様との差分（重要）

`docs/frontend/10-realtime-editing.md` には `useRealtimeSection` を中心とした説明が残っているが、現行実装は以下が異なる。

- 閲覧同期は `useRealtimeSection` 中心ではなく、`SectionViewer` が provider の `section-content` を直接購読
- 同期は Y.js差分のみに依存せず、**JSON Broadcast + 自動保存 + ポーリング** の冗長構成
- WebSocket未接続時でも反映できるよう、REST保存を明示的にフォールバックとして採用

## 5. 今回「残した変更」と「戻した変更」

### 残した変更

- リアルタイム同期とフォールバック同期に必要な変更のみ
- 具体的には `realtime/provider`, `usePlotRealtime`, `SectionEditor`, `SectionViewer`, `SectionList`, `PlotDetail`, `usePlots` と関連テスト

### 戻した変更

- Realtimeに無関係な `USE_MOCK` 条件変更
- エディタ機能（下線・リンク・カラー・BubbleMenu など）の削除系変更
- Realtimeに無関係な新規 hook 追加（`useCreatePlot` など）

## 6. 動作確認の観点

1. Aブラウザでセクション編集開始
2. Bブラウザで同一Plotを閲覧
3. A側入力がB側に即時または数秒以内に反映されること
4. A側「編集完了」前でもB側反映されること
5. 接続不調時でも、2秒〜数秒で内容が追従すること
